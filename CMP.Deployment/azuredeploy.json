{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.5.6.12127",
      "templateHash": "2861453334486859807"
    }
  },
  "parameters": {
    "name": {
      "type": "string",
      "defaultValue": "[format('fn{0}', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "The name of the function app that you wish to create."
      }
    },
    "storageAccountType": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "allowedValues": [
        "Standard_LRS",
        "Standard_GRS",
        "Standard_RAGRS"
      ],
      "metadata": {
        "description": "Storage Account type"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources."
      }
    },
    "clientId": {
      "type": "string",
      "defaultValue": "4147e318-8985-454b-a94c-134d9b780ae5",
      "metadata": {
        "description": "Azure AD client ID for an app registration"
      }
    },
    "domain": {
      "type": "string",
      "defaultValue": "cmpgitops.onmicrosoft.com",
      "metadata": {
        "description": "Azure AD domain used for authentication"
      }
    },
    "azureDevOpsPersonalAccessToken": {
      "type": "secureString",
      "metadata": {
        "description": "Personal Access Token from Azure DevOps, used to read repos and items within repos for a given project"
      }
    }
  },
  "variables": {
    "hostingPlanName": "[parameters('name')]",
    "functionAppName": "[format('fn{0}', parameters('name'))]",
    "webAppName": "[format('web{0}', parameters('name'))]",
    "applicationInsightsName": "[format('ai{0}', parameters('name'))]",
    "storageAccountName": "[format('st{0}', uniqueString(resourceGroup().id))]",
    "searchName": "[format('cs{0}', parameters('name'))]",
    "accountName": "[format('db{0}', parameters('name'))]",
    "databaseName": "CMP",
    "containerName": "DeploymentTemplates",
    "dashboardName": "[format('{0}-dashboard', parameters('name'))]",
    "functionWorkerRuntime": "dotnet",
    "configManagementURL": "https://login.microsoftonline.com/",
    "configCosmosDBURL": "[format('https://{0}.documents.azure.com:443/', variables('accountName'))]",
    "configSearchURL": "[format('https://{0}.search.windows.net', variables('searchName'))]",
    "configDevOpsURL": "https://dev.azure.com/{0}",
    "configDevOpsProject": "CMP",
    "configDevOpsOrganization": "CMPGitOps",
    "configDevOpsRepository": "CloudDeploy",
    "configMetadataFileName": "metadata.json",
    "configSearchIndexName": "cosmosdb-index"
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2021-08-01",
      "name": "[variables('storageAccountName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "[parameters('storageAccountType')]"
      },
      "kind": "Storage"
    },
    {
      "type": "Microsoft.DocumentDB/databaseAccounts",
      "apiVersion": "2021-03-15",
      "name": "[variables('accountName')]",
      "location": "[parameters('location')]",
      "kind": "GlobalDocumentDB",
      "properties": {
        "consistencyPolicy": {
          "defaultConsistencyLevel": "Eventual",
          "maxStalenessPrefix": 1,
          "maxIntervalInSeconds": 5
        },
        "locations": [
          {
            "locationName": "[parameters('location')]",
            "failoverPriority": 0
          }
        ],
        "databaseAccountOfferType": "Standard",
        "enableAutomaticFailover": true,
        "capabilities": [
          {
            "name": "EnableServerless"
          }
        ]
      }
    },
    {
      "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
      "apiVersion": "2021-06-15",
      "name": "[format('{0}/{1}', variables('accountName'), variables('databaseName'))]",
      "properties": {
        "resource": {
          "id": "[variables('databaseName')]"
        },
        "options": {}
      },
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('accountName'))]"
      ]
    },
    {
      "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
      "apiVersion": "2021-06-15",
      "name": "[format('{0}/{1}', format('{0}/{1}', variables('accountName'), variables('databaseName')), variables('containerName'))]",
      "properties": {
        "resource": {
          "id": "[variables('containerName')]",
          "partitionKey": {
            "paths": [
              "/id"
            ],
            "kind": "Hash"
          },
          "indexingPolicy": {
            "indexingMode": "consistent",
            "includedPaths": [
              {
                "path": "/*",
                "indexes": [
                  {
                    "kind": "Hash",
                    "dataType": "String",
                    "precision": -1
                  }
                ]
              }
            ],
            "excludedPaths": [
              {
                "path": "/\"_etag\"/?"
              }
            ]
          }
        },
        "options": {}
      },
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', split(format('{0}/{1}', variables('accountName'), variables('databaseName')), '/')[0], split(format('{0}/{1}', variables('accountName'), variables('databaseName')), '/')[1])]"
      ]
    },
    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2021-03-01",
      "name": "[variables('hostingPlanName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Y1",
        "tier": "Dynamic"
      },
      "properties": {}
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2021-03-01",
      "name": "[variables('functionAppName')]",
      "location": "[parameters('location')]",
      "kind": "functionapp",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]",
        "siteConfig": {
          "appSettings": [
            {
              "name": "AzureWebJobsStorage",
              "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', variables('storageAccountName'), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2021-08-01').keys[0].value)]"
            },
            {
              "name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
              "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', variables('storageAccountName'), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2021-08-01').keys[0].value)]"
            },
            {
              "name": "WEBSITE_CONTENTSHARE",
              "value": "[toLower(variables('functionAppName'))]"
            },
            {
              "name": "FUNCTIONS_EXTENSION_VERSION",
              "value": "~2"
            },
            {
              "name": "WEBSITE_NODE_DEFAULT_VERSION",
              "value": "~10"
            },
            {
              "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))).InstrumentationKey]"
            },
            {
              "name": "FUNCTIONS_WORKER_RUNTIME",
              "value": "[variables('functionWorkerRuntime')]"
            },
            {
              "name": "AzureDevOps:CollectionUri",
              "value": "[variables('configDevOpsURL')]"
            },
            {
              "name": "AzureDevOps:Organization",
              "value": "[variables('configDevOpsOrganization')]"
            },
            {
              "name": "AzureDevOps:Project",
              "value": "[variables('configDevOpsProject')]"
            },
            {
              "name": "AzureDevOps:Repository",
              "value": "[variables('configDevOpsRepository')]"
            },
            {
              "name": "AzureDevOps:PersonalAccessToken",
              "value": "[parameters('azureDevOpsPersonalAccessToken')]"
            },
            {
              "name": "AzureDevOps:MetadataFile",
              "value": "[variables('configMetadataFileName')]"
            },
            {
              "name": "CosmosDb:Account",
              "value": "[variables('configCosmosDBURL')]"
            },
            {
              "name": "CosmosDb:DatabaseName",
              "value": "[variables('databaseName')]"
            },
            {
              "name": "CosmosDb:ContainerName",
              "value": "[variables('containerName')]"
            },
            {
              "name": "CosmosDb:Key",
              "value": "[listKeys(resourceId('Microsoft.DocumentDB/databaseAccounts', variables('accountName')), '2021-03-15').primaryMasterKey]"
            },
            {
              "name": "Schedule",
              "value": "*/10 * * * * *"
            }
          ],
          "ftpsState": "FtpsOnly",
          "minTlsVersion": "1.2"
        },
        "httpsOnly": true
      },
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('accountName'))]",
        "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]",
        "[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
      ]
    },
    {
      "type": "Microsoft.Insights/components",
      "apiVersion": "2020-02-02",
      "name": "[variables('applicationInsightsName')]",
      "location": "[parameters('location')]",
      "kind": "web",
      "properties": {
        "Application_Type": "web",
        "Request_Source": "rest"
      }
    },
    {
      "type": "Microsoft.Search/searchServices",
      "apiVersion": "2021-04-01-preview",
      "name": "[variables('searchName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "standard"
      },
      "properties": {
        "replicaCount": 1,
        "partitionCount": 1,
        "hostingMode": "default",
        "disableLocalAuth": false,
        "authOptions": {
          "apiKeyOnly": {}
        },
        "semanticSearch": "disabled"
      }
    },
    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2020-12-01",
      "name": "[variables('webAppName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "B1",
        "capacity": 1
      }
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2018-11-01",
      "name": "[variables('webAppName')]",
      "location": "[parameters('location')]",
      "tags": {
        "[format('hidden-related:{0}/providers/Microsoft.Web/serverfarms/appServicePlan', resourceGroup().id)]": "Resource"
      },
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('webAppName'))]",
        "siteConfig": {
          "appSettings": [
            {
              "name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
              "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', variables('storageAccountName'), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2021-08-01').keys[0].value)]"
            },
            {
              "name": "WEBSITE_CONTENTSHARE",
              "value": "[toLower(variables('webAppName'))]"
            },
            {
              "name": "WEBSITE_NODE_DEFAULT_VERSION",
              "value": "~10"
            },
            {
              "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))).InstrumentationKey]"
            },
            {
              "name": "AzureDevOps:CollectionUri",
              "value": "[variables('configDevOpsURL')]"
            },
            {
              "name": "AzureDevOps:Organization",
              "value": "[variables('configDevOpsOrganization')]"
            },
            {
              "name": "AzureDevOps:Project",
              "value": "[variables('configDevOpsProject')]"
            },
            {
              "name": "AzureDevOps:Repository",
              "value": "[variables('configDevOpsRepository')]"
            },
            {
              "name": "AzureDevOps:PersonalAccessToken",
              "value": "[parameters('azureDevOpsPersonalAccessToken')]"
            },
            {
              "name": "AzureDevOps:MetadataFile",
              "value": "[variables('configMetadataFileName')]"
            },
            {
              "name": "CosmosDb:Account",
              "value": "[variables('configCosmosDBURL')]"
            },
            {
              "name": "CosmosDb:DatabaseName",
              "value": "[variables('databaseName')]"
            },
            {
              "name": "CosmosDb:ContainerName",
              "value": "[variables('containerName')]"
            },
            {
              "name": "CosmosDb:Key",
              "value": "[listKeys(resourceId('Microsoft.DocumentDB/databaseAccounts', variables('accountName')), '2021-03-15').primaryMasterKey]"
            },
            {
              "name": "Azure:APIVersion",
              "value": "[listKeys(resourceId('Microsoft.DocumentDB/databaseAccounts', variables('accountName')), '2021-03-15').primaryMasterKey]"
            },
            {
              "name": "Azure:APIEndpoint",
              "value": "[listKeys(resourceId('Microsoft.DocumentDB/databaseAccounts', variables('accountName')), '2021-03-15').primaryMasterKey]"
            },
            {
              "name": "Azure:TenantId",
              "value": "[listKeys(resourceId('Microsoft.DocumentDB/databaseAccounts', variables('accountName')), '2021-03-15').primaryMasterKey]"
            },
            {
              "name": "AzureAd:Instance",
              "value": "[variables('configManagementURL')]"
            },
            {
              "name": "AzureAd:Domain",
              "value": "[parameters('domain')]"
            },
            {
              "name": "AzureAd:TenantId",
              "value": "[tenant().tenantId]"
            },
            {
              "name": "AzureAd:ClientId",
              "value": "[parameters('clientId')]"
            },
            {
              "name": "AzureAd:Scopes",
              "value": "access_as_user"
            },
            {
              "name": "AzureAd:CallbackPath",
              "value": "/signin-oidc"
            },
            {
              "name": "AzureAd:SignedOutCallbackPath",
              "value": "/signout-callback-oidc"
            },
            {
              "name": "AzureSearch:SearchServiceUri",
              "value": "[variables('configSearchURL')]"
            },
            {
              "name": "AzureSearch:SearchServiceQueryApiKey",
              "value": "[listQueryKeys(resourceId('Microsoft.Search/searchServices', variables('searchName')), '2021-04-01-preview').value[0].key]"
            },
            {
              "name": "AzureSearch:IndexName",
              "value": "[variables('configSearchIndexName')]"
            }
          ],
          "ftpsState": "FtpsOnly",
          "minTlsVersion": "1.2"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('accountName'))]",
        "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]",
        "[resourceId('Microsoft.Search/searchServices', variables('searchName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
        "[resourceId('Microsoft.Web/serverfarms', variables('webAppName'))]"
      ]
    },
    {
      "type": "Microsoft.Portal/dashboards",
      "apiVersion": "2015-08-01-preview",
      "name": "[variables('dashboardName')]",
      "location": "[parameters('location')]",
      "tags": {
        "hidden-title": "[format('{0} Dashboard', parameters('name'))]"
      },
      "properties": {
        "lenses": {
          "0": {
            "order": 0,
            "parts": {
              "0": {
                "position": {
                  "x": 0,
                  "y": 0,
                  "colSpan": 2,
                  "rowSpan": 1
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "id",
                      "value": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
                    },
                    {
                      "name": "Version",
                      "value": "1.0"
                    }
                  ],
                  "type": "Extension/AppInsightsExtension/PartType/AspNetOverviewPinnedPart",
                  "asset": {
                    "idInputName": "id",
                    "type": "ApplicationInsights"
                  },
                  "defaultMenuItemId": "overview"
                }
              },
              "1": {
                "position": {
                  "x": 2,
                  "y": 0,
                  "colSpan": 1,
                  "rowSpan": 1
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "ComponentId",
                      "value": {
                        "Name": "[variables('applicationInsightsName')]",
                        "SubscriptionId": "[subscription().id]",
                        "ResourceGroup": "[resourceGroup().name]"
                      }
                    },
                    {
                      "name": "Version",
                      "value": "1.0"
                    }
                  ],
                  "type": "Extension/AppInsightsExtension/PartType/ProactiveDetectionAsyncPart",
                  "asset": {
                    "idInputName": "ComponentId",
                    "type": "ApplicationInsights"
                  },
                  "defaultMenuItemId": "ProactiveDetection"
                }
              },
              "2": {
                "position": {
                  "x": 3,
                  "y": 0,
                  "colSpan": 1,
                  "rowSpan": 1
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "ComponentId",
                      "value": {
                        "Name": "[variables('applicationInsightsName')]",
                        "SubscriptionId": "[subscription().id]",
                        "ResourceGroup": "[resourceGroup().name]"
                      }
                    },
                    {
                      "name": "ResourceId",
                      "value": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
                    }
                  ],
                  "type": "Extension/AppInsightsExtension/PartType/QuickPulseButtonSmallPart",
                  "asset": {
                    "idInputName": "ComponentId",
                    "type": "ApplicationInsights"
                  }
                }
              },
              "3": {
                "position": {
                  "x": 4,
                  "y": 0,
                  "colSpan": 1,
                  "rowSpan": 1
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "ComponentId",
                      "value": {
                        "Name": "[variables('applicationInsightsName')]",
                        "SubscriptionId": "[subscription().id]",
                        "ResourceGroup": "[resourceGroup().name]"
                      }
                    },
                    {
                      "name": "TimeContext",
                      "value": {
                        "durationMs": 86400000,
                        "endTime": null,
                        "createdTime": "2018-05-04T01:20:33.345Z",
                        "isInitialTime": true,
                        "grain": 1,
                        "useDashboardTimeRange": false
                      }
                    },
                    {
                      "name": "Version",
                      "value": "1.0"
                    }
                  ],
                  "type": "Extension/AppInsightsExtension/PartType/AvailabilityNavButtonPart",
                  "asset": {
                    "idInputName": "ComponentId",
                    "type": "ApplicationInsights"
                  }
                }
              },
              "4": {
                "position": {
                  "x": 5,
                  "y": 0,
                  "colSpan": 1,
                  "rowSpan": 1
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "ComponentId",
                      "value": {
                        "Name": "[variables('applicationInsightsName')]",
                        "SubscriptionId": "[subscription().id]",
                        "ResourceGroup": "[resourceGroup().name]"
                      }
                    },
                    {
                      "name": "TimeContext",
                      "value": {
                        "durationMs": 86400000,
                        "endTime": null,
                        "createdTime": "2018-05-08T18:47:35.237Z",
                        "isInitialTime": true,
                        "grain": 1,
                        "useDashboardTimeRange": false
                      }
                    },
                    {
                      "name": "ConfigurationId",
                      "value": "78ce933e-e864-4b05-a27b-71fd55a6afad"
                    }
                  ],
                  "type": "Extension/AppInsightsExtension/PartType/AppMapButtonPart",
                  "asset": {
                    "idInputName": "ComponentId",
                    "type": "ApplicationInsights"
                  }
                }
              },
              "5": {
                "position": {
                  "x": 0,
                  "y": 1,
                  "colSpan": 3,
                  "rowSpan": 1
                },
                "metadata": {
                  "inputs": [],
                  "type": "Extension/HubsExtension/PartType/MarkdownPart",
                  "settings": {
                    "content": {
                      "settings": {
                        "content": "# Usage",
                        "title": "",
                        "subtitle": ""
                      }
                    }
                  }
                }
              },
              "6": {
                "position": {
                  "x": 3,
                  "y": 1,
                  "colSpan": 1,
                  "rowSpan": 1
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "ComponentId",
                      "value": {
                        "Name": "[variables('applicationInsightsName')]",
                        "SubscriptionId": "[subscription().id]",
                        "ResourceGroup": "[resourceGroup().name]"
                      }
                    },
                    {
                      "name": "TimeContext",
                      "value": {
                        "durationMs": 86400000,
                        "endTime": null,
                        "createdTime": "2018-05-04T01:22:35.782Z",
                        "isInitialTime": true,
                        "grain": 1,
                        "useDashboardTimeRange": false
                      }
                    }
                  ],
                  "type": "Extension/AppInsightsExtension/PartType/UsageUsersOverviewPart",
                  "asset": {
                    "idInputName": "ComponentId",
                    "type": "ApplicationInsights"
                  }
                }
              },
              "7": {
                "position": {
                  "x": 4,
                  "y": 1,
                  "colSpan": 3,
                  "rowSpan": 1
                },
                "metadata": {
                  "inputs": [],
                  "type": "Extension/HubsExtension/PartType/MarkdownPart",
                  "settings": {
                    "content": {
                      "settings": {
                        "content": "# Reliability",
                        "title": "",
                        "subtitle": ""
                      }
                    }
                  }
                }
              },
              "8": {
                "position": {
                  "x": 7,
                  "y": 1,
                  "colSpan": 1,
                  "rowSpan": 1
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "ResourceId",
                      "value": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
                    },
                    {
                      "name": "DataModel",
                      "value": {
                        "version": "1.0.0",
                        "timeContext": {
                          "durationMs": 86400000,
                          "createdTime": "2018-05-04T23:42:40.072Z",
                          "isInitialTime": false,
                          "grain": 1,
                          "useDashboardTimeRange": false
                        }
                      },
                      "isOptional": true
                    },
                    {
                      "name": "ConfigurationId",
                      "value": "8a02f7bf-ac0f-40e1-afe9-f0e72cfee77f",
                      "isOptional": true
                    }
                  ],
                  "type": "Extension/AppInsightsExtension/PartType/CuratedBladeFailuresPinnedPart",
                  "isAdapter": true,
                  "asset": {
                    "idInputName": "ResourceId",
                    "type": "ApplicationInsights"
                  },
                  "defaultMenuItemId": "failures"
                }
              },
              "9": {
                "position": {
                  "x": 8,
                  "y": 1,
                  "colSpan": 3,
                  "rowSpan": 1
                },
                "metadata": {
                  "inputs": [],
                  "type": "Extension/HubsExtension/PartType/MarkdownPart",
                  "settings": {
                    "content": {
                      "settings": {
                        "content": "# Responsiveness\r\n",
                        "title": "",
                        "subtitle": ""
                      }
                    }
                  }
                }
              },
              "10": {
                "position": {
                  "x": 11,
                  "y": 1,
                  "colSpan": 1,
                  "rowSpan": 1
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "ResourceId",
                      "value": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
                    },
                    {
                      "name": "DataModel",
                      "value": {
                        "version": "1.0.0",
                        "timeContext": {
                          "durationMs": 86400000,
                          "createdTime": "2018-05-04T23:43:37.804Z",
                          "isInitialTime": false,
                          "grain": 1,
                          "useDashboardTimeRange": false
                        }
                      },
                      "isOptional": true
                    },
                    {
                      "name": "ConfigurationId",
                      "value": "2a8ede4f-2bee-4b9c-aed9-2db0e8a01865",
                      "isOptional": true
                    }
                  ],
                  "type": "Extension/AppInsightsExtension/PartType/CuratedBladePerformancePinnedPart",
                  "isAdapter": true,
                  "asset": {
                    "idInputName": "ResourceId",
                    "type": "ApplicationInsights"
                  },
                  "defaultMenuItemId": "performance"
                }
              },
              "11": {
                "position": {
                  "x": 12,
                  "y": 1,
                  "colSpan": 3,
                  "rowSpan": 1
                },
                "metadata": {
                  "inputs": [],
                  "type": "Extension/HubsExtension/PartType/MarkdownPart",
                  "settings": {
                    "content": {
                      "settings": {
                        "content": "# Browser",
                        "title": "",
                        "subtitle": ""
                      }
                    }
                  }
                }
              },
              "12": {
                "position": {
                  "x": 15,
                  "y": 1,
                  "colSpan": 1,
                  "rowSpan": 1
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "ComponentId",
                      "value": {
                        "Name": "[variables('applicationInsightsName')]",
                        "SubscriptionId": "[subscription().id]",
                        "ResourceGroup": "[resourceGroup().name]"
                      }
                    },
                    {
                      "name": "MetricsExplorerJsonDefinitionId",
                      "value": "BrowserPerformanceTimelineMetrics"
                    },
                    {
                      "name": "TimeContext",
                      "value": {
                        "durationMs": 86400000,
                        "createdTime": "2018-05-08T12:16:27.534Z",
                        "isInitialTime": false,
                        "grain": 1,
                        "useDashboardTimeRange": false
                      }
                    },
                    {
                      "name": "CurrentFilter",
                      "value": {
                        "eventTypes": [
                          4,
                          1,
                          3,
                          5,
                          2,
                          6,
                          13
                        ],
                        "typeFacets": {},
                        "isPermissive": false
                      }
                    },
                    {
                      "name": "id",
                      "value": {
                        "Name": "[variables('applicationInsightsName')]",
                        "SubscriptionId": "[subscription().id]",
                        "ResourceGroup": "[resourceGroup().name]"
                      }
                    },
                    {
                      "name": "Version",
                      "value": "1.0"
                    }
                  ],
                  "type": "Extension/AppInsightsExtension/PartType/MetricsExplorerBladePinnedPart",
                  "asset": {
                    "idInputName": "ComponentId",
                    "type": "ApplicationInsights"
                  },
                  "defaultMenuItemId": "browser"
                }
              },
              "13": {
                "position": {
                  "x": 0,
                  "y": 2,
                  "colSpan": 4,
                  "rowSpan": 3
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "options",
                      "value": {
                        "chart": {
                          "metrics": [
                            {
                              "resourceMetadata": {
                                "id": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
                              },
                              "name": "sessions/count",
                              "aggregationType": 5,
                              "namespace": "microsoft.insights/components/kusto",
                              "metricVisualization": {
                                "displayName": "Sessions",
                                "color": "#47BDF5"
                              }
                            },
                            {
                              "resourceMetadata": {
                                "id": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
                              },
                              "name": "users/count",
                              "aggregationType": 5,
                              "namespace": "microsoft.insights/components/kusto",
                              "metricVisualization": {
                                "displayName": "Users",
                                "color": "#7E58FF"
                              }
                            }
                          ],
                          "title": "Unique sessions and users",
                          "visualization": {
                            "chartType": 2,
                            "legendVisualization": {
                              "isVisible": true,
                              "position": 2,
                              "hideSubtitle": false
                            },
                            "axisVisualization": {
                              "x": {
                                "isVisible": true,
                                "axisType": 2
                              },
                              "y": {
                                "isVisible": true,
                                "axisType": 1
                              }
                            }
                          },
                          "openBladeOnClick": {
                            "openBlade": true,
                            "destinationBlade": {
                              "extensionName": "HubsExtension",
                              "bladeName": "ResourceMenuBlade",
                              "parameters": {
                                "id": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]",
                                "menuid": "segmentationUsers"
                              }
                            }
                          }
                        }
                      }
                    },
                    {
                      "name": "sharedTimeRange",
                      "isOptional": true
                    }
                  ],
                  "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                  "settings": {}
                }
              },
              "14": {
                "position": {
                  "x": 4,
                  "y": 2,
                  "colSpan": 4,
                  "rowSpan": 3
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "options",
                      "value": {
                        "chart": {
                          "metrics": [
                            {
                              "resourceMetadata": {
                                "id": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
                              },
                              "name": "requests/failed",
                              "aggregationType": 7,
                              "namespace": "microsoft.insights/components",
                              "metricVisualization": {
                                "displayName": "Failed requests",
                                "color": "#EC008C"
                              }
                            }
                          ],
                          "title": "Failed requests",
                          "visualization": {
                            "chartType": 3,
                            "legendVisualization": {
                              "isVisible": true,
                              "position": 2,
                              "hideSubtitle": false
                            },
                            "axisVisualization": {
                              "x": {
                                "isVisible": true,
                                "axisType": 2
                              },
                              "y": {
                                "isVisible": true,
                                "axisType": 1
                              }
                            }
                          },
                          "openBladeOnClick": {
                            "openBlade": true,
                            "destinationBlade": {
                              "extensionName": "HubsExtension",
                              "bladeName": "ResourceMenuBlade",
                              "parameters": {
                                "id": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]",
                                "menuid": "failures"
                              }
                            }
                          }
                        }
                      }
                    },
                    {
                      "name": "sharedTimeRange",
                      "isOptional": true
                    }
                  ],
                  "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                  "settings": {}
                }
              },
              "15": {
                "position": {
                  "x": 8,
                  "y": 2,
                  "colSpan": 4,
                  "rowSpan": 3
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "options",
                      "value": {
                        "chart": {
                          "metrics": [
                            {
                              "resourceMetadata": {
                                "id": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
                              },
                              "name": "requests/duration",
                              "aggregationType": 4,
                              "namespace": "microsoft.insights/components",
                              "metricVisualization": {
                                "displayName": "Server response time",
                                "color": "#00BCF2"
                              }
                            }
                          ],
                          "title": "Server response time",
                          "visualization": {
                            "chartType": 2,
                            "legendVisualization": {
                              "isVisible": true,
                              "position": 2,
                              "hideSubtitle": false
                            },
                            "axisVisualization": {
                              "x": {
                                "isVisible": true,
                                "axisType": 2
                              },
                              "y": {
                                "isVisible": true,
                                "axisType": 1
                              }
                            }
                          },
                          "openBladeOnClick": {
                            "openBlade": true,
                            "destinationBlade": {
                              "extensionName": "HubsExtension",
                              "bladeName": "ResourceMenuBlade",
                              "parameters": {
                                "id": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]",
                                "menuid": "performance"
                              }
                            }
                          }
                        }
                      }
                    },
                    {
                      "name": "sharedTimeRange",
                      "isOptional": true
                    }
                  ],
                  "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                  "settings": {}
                }
              },
              "16": {
                "position": {
                  "x": 12,
                  "y": 2,
                  "colSpan": 4,
                  "rowSpan": 3
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "options",
                      "value": {
                        "chart": {
                          "metrics": [
                            {
                              "resourceMetadata": {
                                "id": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
                              },
                              "name": "browserTimings/networkDuration",
                              "aggregationType": 4,
                              "namespace": "microsoft.insights/components",
                              "metricVisualization": {
                                "displayName": "Page load network connect time",
                                "color": "#7E58FF"
                              }
                            },
                            {
                              "resourceMetadata": {
                                "id": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
                              },
                              "name": "browserTimings/processingDuration",
                              "aggregationType": 4,
                              "namespace": "microsoft.insights/components",
                              "metricVisualization": {
                                "displayName": "Client processing time",
                                "color": "#44F1C8"
                              }
                            },
                            {
                              "resourceMetadata": {
                                "id": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
                              },
                              "name": "browserTimings/sendDuration",
                              "aggregationType": 4,
                              "namespace": "microsoft.insights/components",
                              "metricVisualization": {
                                "displayName": "Send request time",
                                "color": "#EB9371"
                              }
                            },
                            {
                              "resourceMetadata": {
                                "id": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
                              },
                              "name": "browserTimings/receiveDuration",
                              "aggregationType": 4,
                              "namespace": "microsoft.insights/components",
                              "metricVisualization": {
                                "displayName": "Receiving response time",
                                "color": "#0672F1"
                              }
                            }
                          ],
                          "title": "Average page load time breakdown",
                          "visualization": {
                            "chartType": 3,
                            "legendVisualization": {
                              "isVisible": true,
                              "position": 2,
                              "hideSubtitle": false
                            },
                            "axisVisualization": {
                              "x": {
                                "isVisible": true,
                                "axisType": 2
                              },
                              "y": {
                                "isVisible": true,
                                "axisType": 1
                              }
                            }
                          }
                        }
                      }
                    },
                    {
                      "name": "sharedTimeRange",
                      "isOptional": true
                    }
                  ],
                  "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                  "settings": {}
                }
              },
              "17": {
                "position": {
                  "x": 0,
                  "y": 5,
                  "colSpan": 4,
                  "rowSpan": 3
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "options",
                      "value": {
                        "chart": {
                          "metrics": [
                            {
                              "resourceMetadata": {
                                "id": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
                              },
                              "name": "availabilityResults/availabilityPercentage",
                              "aggregationType": 4,
                              "namespace": "microsoft.insights/components",
                              "metricVisualization": {
                                "displayName": "Availability",
                                "color": "#47BDF5"
                              }
                            }
                          ],
                          "title": "Average availability",
                          "visualization": {
                            "chartType": 3,
                            "legendVisualization": {
                              "isVisible": true,
                              "position": 2,
                              "hideSubtitle": false
                            },
                            "axisVisualization": {
                              "x": {
                                "isVisible": true,
                                "axisType": 2
                              },
                              "y": {
                                "isVisible": true,
                                "axisType": 1
                              }
                            }
                          },
                          "openBladeOnClick": {
                            "openBlade": true,
                            "destinationBlade": {
                              "extensionName": "HubsExtension",
                              "bladeName": "ResourceMenuBlade",
                              "parameters": {
                                "id": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]",
                                "menuid": "availability"
                              }
                            }
                          }
                        }
                      }
                    },
                    {
                      "name": "sharedTimeRange",
                      "isOptional": true
                    }
                  ],
                  "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                  "settings": {}
                }
              },
              "18": {
                "position": {
                  "x": 4,
                  "y": 5,
                  "colSpan": 4,
                  "rowSpan": 3
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "options",
                      "value": {
                        "chart": {
                          "metrics": [
                            {
                              "resourceMetadata": {
                                "id": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
                              },
                              "name": "exceptions/server",
                              "aggregationType": 7,
                              "namespace": "microsoft.insights/components",
                              "metricVisualization": {
                                "displayName": "Server exceptions",
                                "color": "#47BDF5"
                              }
                            },
                            {
                              "resourceMetadata": {
                                "id": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
                              },
                              "name": "dependencies/failed",
                              "aggregationType": 7,
                              "namespace": "microsoft.insights/components",
                              "metricVisualization": {
                                "displayName": "Dependency failures",
                                "color": "#7E58FF"
                              }
                            }
                          ],
                          "title": "Server exceptions and Dependency failures",
                          "visualization": {
                            "chartType": 2,
                            "legendVisualization": {
                              "isVisible": true,
                              "position": 2,
                              "hideSubtitle": false
                            },
                            "axisVisualization": {
                              "x": {
                                "isVisible": true,
                                "axisType": 2
                              },
                              "y": {
                                "isVisible": true,
                                "axisType": 1
                              }
                            }
                          }
                        }
                      }
                    },
                    {
                      "name": "sharedTimeRange",
                      "isOptional": true
                    }
                  ],
                  "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                  "settings": {}
                }
              },
              "19": {
                "position": {
                  "x": 8,
                  "y": 5,
                  "colSpan": 4,
                  "rowSpan": 3
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "options",
                      "value": {
                        "chart": {
                          "metrics": [
                            {
                              "resourceMetadata": {
                                "id": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
                              },
                              "name": "performanceCounters/processorCpuPercentage",
                              "aggregationType": 4,
                              "namespace": "microsoft.insights/components",
                              "metricVisualization": {
                                "displayName": "Processor time",
                                "color": "#47BDF5"
                              }
                            },
                            {
                              "resourceMetadata": {
                                "id": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
                              },
                              "name": "performanceCounters/processCpuPercentage",
                              "aggregationType": 4,
                              "namespace": "microsoft.insights/components",
                              "metricVisualization": {
                                "displayName": "Process CPU",
                                "color": "#7E58FF"
                              }
                            }
                          ],
                          "title": "Average processor and process CPU utilization",
                          "visualization": {
                            "chartType": 2,
                            "legendVisualization": {
                              "isVisible": true,
                              "position": 2,
                              "hideSubtitle": false
                            },
                            "axisVisualization": {
                              "x": {
                                "isVisible": true,
                                "axisType": 2
                              },
                              "y": {
                                "isVisible": true,
                                "axisType": 1
                              }
                            }
                          }
                        }
                      }
                    },
                    {
                      "name": "sharedTimeRange",
                      "isOptional": true
                    }
                  ],
                  "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                  "settings": {}
                }
              },
              "20": {
                "position": {
                  "x": 12,
                  "y": 5,
                  "colSpan": 4,
                  "rowSpan": 3
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "options",
                      "value": {
                        "chart": {
                          "metrics": [
                            {
                              "resourceMetadata": {
                                "id": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
                              },
                              "name": "exceptions/browser",
                              "aggregationType": 7,
                              "namespace": "microsoft.insights/components",
                              "metricVisualization": {
                                "displayName": "Browser exceptions",
                                "color": "#47BDF5"
                              }
                            }
                          ],
                          "title": "Browser exceptions",
                          "visualization": {
                            "chartType": 2,
                            "legendVisualization": {
                              "isVisible": true,
                              "position": 2,
                              "hideSubtitle": false
                            },
                            "axisVisualization": {
                              "x": {
                                "isVisible": true,
                                "axisType": 2
                              },
                              "y": {
                                "isVisible": true,
                                "axisType": 1
                              }
                            }
                          }
                        }
                      }
                    },
                    {
                      "name": "sharedTimeRange",
                      "isOptional": true
                    }
                  ],
                  "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                  "settings": {}
                }
              },
              "21": {
                "position": {
                  "x": 0,
                  "y": 8,
                  "colSpan": 4,
                  "rowSpan": 3
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "options",
                      "value": {
                        "chart": {
                          "metrics": [
                            {
                              "resourceMetadata": {
                                "id": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
                              },
                              "name": "availabilityResults/count",
                              "aggregationType": 7,
                              "namespace": "microsoft.insights/components",
                              "metricVisualization": {
                                "displayName": "Availability test results count",
                                "color": "#47BDF5"
                              }
                            }
                          ],
                          "title": "Availability test results count",
                          "visualization": {
                            "chartType": 2,
                            "legendVisualization": {
                              "isVisible": true,
                              "position": 2,
                              "hideSubtitle": false
                            },
                            "axisVisualization": {
                              "x": {
                                "isVisible": true,
                                "axisType": 2
                              },
                              "y": {
                                "isVisible": true,
                                "axisType": 1
                              }
                            }
                          }
                        }
                      }
                    },
                    {
                      "name": "sharedTimeRange",
                      "isOptional": true
                    }
                  ],
                  "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                  "settings": {}
                }
              },
              "22": {
                "position": {
                  "x": 4,
                  "y": 8,
                  "colSpan": 4,
                  "rowSpan": 3
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "options",
                      "value": {
                        "chart": {
                          "metrics": [
                            {
                              "resourceMetadata": {
                                "id": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
                              },
                              "name": "performanceCounters/processIOBytesPerSecond",
                              "aggregationType": 4,
                              "namespace": "microsoft.insights/components",
                              "metricVisualization": {
                                "displayName": "Process IO rate",
                                "color": "#47BDF5"
                              }
                            }
                          ],
                          "title": "Average process I/O rate",
                          "visualization": {
                            "chartType": 2,
                            "legendVisualization": {
                              "isVisible": true,
                              "position": 2,
                              "hideSubtitle": false
                            },
                            "axisVisualization": {
                              "x": {
                                "isVisible": true,
                                "axisType": 2
                              },
                              "y": {
                                "isVisible": true,
                                "axisType": 1
                              }
                            }
                          }
                        }
                      }
                    },
                    {
                      "name": "sharedTimeRange",
                      "isOptional": true
                    }
                  ],
                  "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                  "settings": {}
                }
              },
              "23": {
                "position": {
                  "x": 8,
                  "y": 8,
                  "colSpan": 4,
                  "rowSpan": 3
                },
                "metadata": {
                  "inputs": [
                    {
                      "name": "options",
                      "value": {
                        "chart": {
                          "metrics": [
                            {
                              "resourceMetadata": {
                                "id": "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
                              },
                              "name": "performanceCounters/memoryAvailableBytes",
                              "aggregationType": 4,
                              "namespace": "microsoft.insights/components",
                              "metricVisualization": {
                                "displayName": "Available memory",
                                "color": "#47BDF5"
                              }
                            }
                          ],
                          "title": "Average available memory",
                          "visualization": {
                            "chartType": 2,
                            "legendVisualization": {
                              "isVisible": true,
                              "position": 2,
                              "hideSubtitle": false
                            },
                            "axisVisualization": {
                              "x": {
                                "isVisible": true,
                                "axisType": 2
                              },
                              "y": {
                                "isVisible": true,
                                "axisType": 1
                              }
                            }
                          }
                        }
                      }
                    },
                    {
                      "name": "sharedTimeRange",
                      "isOptional": true
                    }
                  ],
                  "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                  "settings": {}
                }
              }
            }
          }
        },
        "metadata": {
          "model": {}
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Insights/components', variables('applicationInsightsName'))]"
      ]
    }
  ]
}